<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>TP1</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    </head>
    <body class="container">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <a class="navbar-brand" href="#">Navbar</a>
            </nav>
        </div>
        <h3 class="pt-5">
            Listing
        </h3>
        <div class="table-responsive">
            <table class="table table-bordered">
                <caption id="total"></caption>
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Product</th>
                        <th scope="col">Brand</th>
                        <th scope="col">categories</th>
                        <th scope="col">VAT</th>
                        <th scope="col">Unit Price</th>
                        <th scope="col">Price (VAT Included)</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody id="product-tbody"></tbody>
            </table>
        </div>
        <h3 class="pt-5">
            Cart
        </h3>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th scope="col">Product</th>
                        <th scope="col">Quantity</th>
                        <th scope="col">Total</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody id="cart-tbody"></tbody>
                <tfoot id="cart-tfoot"></tfoot>
            </table>
        </div>
    </body>
    <script>
        // Mock
        let cart = [
            {
                productId: 1,
                quantity: 1
            }
        ]
        let products = [
            {
                id: 1,
                name: 'iPhone XR',
                price: 999,
                vat: 20,
                brand: {
                    id: 1,
                    name: 'Apple'
                },
                categories: ['electronic', 'smartphone']
            },
            {
                id: 2,
                name: 'Helios 300',
                price: 10,
                vat: 20,
                brand: {
                    id: 2,
                    name: 'Acer'
                },
                categories: ['electronic', 'laptop', 'Gaming laptop']
            },
            {
                id: 3,
                name: 'DELL',
                price: 12000,
                vat: 20,
                brand: {
                    id: 3,
                    name: 'DELL'
                },
                categories: ['electronic', 'laptop', 'Gaming laptop']
            },
        ]
        //
        const cartTBody = document.getElementById('cart-tbody')
        const cartTFoot = document.getElementById('cart-tfoot')
        const productTBody = document.getElementById('product-tbody')
        const productCaption = document.getElementById('total')
        // Helpers
        const findProductIndex = id => products.findIndex(product=>product.id === id)
        const findCartElementIndex = id => cart.findIndex(cartElement=>cartElement.productId === id)
        const getProduct = id => {
            const index = findProductIndex(id)

            return index !== -1 ? products[index] : undefined
        }
        const refreshCart = () => {
            cartTBody.innerHTML = ''

            cart.forEach(cartElement=>{
                const {productId, quantity} = cartElement
                const product = getProduct(productId)
                const {name, brand:{name:brandName}} = product
                cartTBody.innerHTML += (
                    `<tr>
                        <th scope="row">${brandName} ${name}</th>
                        <td>
                            <input type="number" class="form-control form-control-sm" value="${quantity}" min="1" onchange="addToCart(${productId}, parseInt(this.value), true)"/>
                        </td>
                        <td>${toCurrency(quantity*getPriceWithVat(product))}</td>
                        <td>
                            <button class="btn btn-outline-success btn-sm w-100" onclick="removeFromCart(${productId})">
                                Remove
                            </button>
                        </td>
                    </tr>`
                )
            })

            let toPay = 0
            cart.forEach(cartElement => {
                const {productId, quantity} = cartElement
                const product = getProduct(productId)
                toPay += quantity*getPriceWithVat(product)
            })

            cartTFoot.innerHTML = (
                `<tr>
                    <td></td>
                    <td></td>
                    <td class="text-primary">${toCurrency(toPay)}</td>
                    <td></td>
                </tr>`
            )
        }
        const addToCart = (id, quantity, reset = false) => {
            const index = findCartElementIndex(id)
            if (index === -1) {
                cart = [
                    ...cart,
                    {
                        productId:id,
                        quantity
                    }
                ]
            } else {
                if (reset) {
                    cart[index].quantity = quantity
                } else {
                    cart[index].quantity += quantity
                }

            }
            refreshCart()
        }
        const removeFromCart = id => {
            const index = findCartElementIndex(id)
            if (index !== -1) {
                cart.splice(index, 1)
                refreshCart()
            }
        }
        const getPriceWithVat = product => {
            const {price, vat} = product

            return price + price * vat / 100
        }
        const toCurrency = value => `${value.toFixed(2)} MAD`
        // Rendering
        products.forEach(product=>{
            const {id, name, price, vat, brand:{name:brandName}, categories} = product
            productTBody.innerHTML += (
                `<tr>
                    <th scope="row">${id}</th>
                    <td>${name}</td>
                    <td><span class="badge bg-primary">${brandName}</span></td>
                    <td>${categories.join(', ')}</td>
                    <td>${vat}</td>
                    <td>${toCurrency(price)}</td>
                    <td>${toCurrency(getPriceWithVat(product))}</td>
                    <td>
                        <button class="btn btn-outline-success btn-sm" onclick="addToCart(${id}, 1)">
                            Add to cart
                        </button>
                    </td>
                </tr>`
            )
        })
        productCaption.innerHTML = `${products.length} product${products.length !== 0 && 's'}`
        refreshCart()
    </script>
</html>